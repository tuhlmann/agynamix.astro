---
import PageLayout from "../../layouts/page-layout.astro";
import PostPreview from "../../components/PostPreview.astro";
import authorData from "../../data/authors.json";
import { kebabCase } from "../../utils/kebab-case";
import { TextLink } from "../../blocks/TextLink.tsx";

export async function getStaticPaths() {
  const allPosts = Object.values(
    import.meta.glob('../blog/**/index.md', { eager: true }),
  ) as any[];
  const allTagsUnique = [...new Set(allPosts.flatMap(p => p.frontmatter.tags))].map(t => kebabCase(t)).sort()

  const sortedPosts = allPosts.sort((a, b) => new Date(b.frontmatter.date).valueOf() - new Date(a.frontmatter.date).valueOf());

  const postsPerTag = allTagsUnique.map(tag => {
    const posts = sortedPosts.filter(p => p.frontmatter.tags?.map(t => kebabCase(t)).includes(tag))

    return {
      posts,
      tag,
      count: posts.length
    }
  })


	return allTagsUnique.map(tag => ({
    params: { tag },
    props: {
      tag,
      allPosts: postsPerTag.find(p => p.tag === tag)?.posts
    }
  }))
}

const { allPosts, tag } = Astro.props as any;

const totalCount = allPosts?.length ?? 0;
const tagHeader = `${totalCount} post${totalCount === 1 ? "" : "s"} tagged with "${tag}"`;
---
<PageLayout activePage="tags" title="Tags">
  <div class="w-full max-w-[1000px] py-10 pt-0 ml-auto mr-auto mt-0 mb-0">
    <div class="max-w-[1000px] mx-auto mb-6 px-2 sm:px-0">
      <h1 class="text-2xl font-bold tracking-tight text-gray-900">
        {tagHeader}
      </h1>
      <div class="mt-2 text-gray-600">
        <TextLink to="/tags/">All Tags</TextLink>
      </div>
    </div>

    <div class="max-w-lg mx-auto grid gap-5 lg:grid-cols-3 lg:max-w-none">
      {allPosts?.map((post: any) => (
        <PostPreview post={post} author={authorData[post.author]} />
      ))}
    </div>
  </div>
</PageLayout>